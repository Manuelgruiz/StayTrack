services:
  db:
    image: postgres:16-alpine
    restart: always
    environment:
      POSTGRES_USER: ${DB_USER:-staytrack}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-staytrack_pass}
      POSTGRES_DB: ${DB_NAME:-staytrack_db}
    volumes:
      - db_data:/var/lib/postgresql/data
    networks:
      - staytrack-net

  auth-service:
    build: ./app/services/auth-service
    restart: always
    environment:
      AUTH_DATABASE_URL: postgresql://${DB_USER:-staytrack}:${DB_PASSWORD:-staytrack_pass}@db:5432/${DB_NAME:-staytrack_db}
      JWT_SECRET: ${JWT_SECRET:-dev-secret-key-12345}
      JWT_ALG: HS256
      USER_SVC: http://user-service:8000
    depends_on:
      - db
    networks:
      - staytrack-net

  user-service:
    build: ./app/services/user-service
    restart: always
    environment:
      USER_DATABASE_URL: postgresql://${DB_USER:-staytrack}:${DB_PASSWORD:-staytrack_pass}@db:5432/${DB_NAME:-staytrack_db}
    depends_on:
      - db
    networks:
      - staytrack-net

  catalog-service:
    build: ./app/services/catalog-service
    restart: always
    environment:
      CATALOG_DATABASE_URL: postgresql://${DB_USER:-staytrack}:${DB_PASSWORD:-staytrack_pass}@db:5432/${DB_NAME:-staytrack_db}
    depends_on:
      - db
    networks:
      - staytrack-net

  goals-service:
    build: ./app/services/goals-service
    restart: always
    environment:
      GOALS_DATABASE_URL: postgresql://${DB_USER:-staytrack}:${DB_PASSWORD:-staytrack_pass}@db:5432/${DB_NAME:-staytrack_db}
    depends_on:
      - db
    networks:
      - staytrack-net

  stats-service:
    build: ./app/services/stats-service
    restart: always
    environment:
      STATS_DATABASE_URL: postgresql://${DB_USER:-staytrack}:${DB_PASSWORD:-staytrack_pass}@db:5432/${DB_NAME:-staytrack_db}
      TRACKER_SVC: http://tracker-service:8000
      GOALS_SVC: http://goals-service:8000
    depends_on:
      - db
    networks:
      - staytrack-net

  tracker-service:
    build: ./app/services/tracker-service
    restart: always
    environment:
      TRACKER_DATABASE_URL: postgresql://${DB_USER:-staytrack}:${DB_PASSWORD:-staytrack_pass}@db:5432/${DB_NAME:-staytrack_db}
    depends_on:
      - db
    networks:
      - staytrack-net

  staytrack-gateway:
    build: ./app/gateway
    restart: always
    ports:
      - "8000:8000"
    environment:
      AUTH_SVC: http://auth-service:8000
      USER_SVC: http://user-service:8000
      TRACKER_SVC: http://tracker-service:8000
      GOALS_SVC: http://goals-service:8000
      STATS_SVC: http://stats-service:8000
      CATALOG_SVC: http://catalog-service:8000
      JWT_SECRET: ${JWT_SECRET:-dev-secret-key-12345}
      JWT_ALG: HS256
    depends_on:
      - auth-service
      - user-service
    networks:
      - staytrack-net

  frontend:
    build: ./frontend
    restart: always
    ports:
      - "80:80"
    environment:
      - VITE_API_URL=http://staytrack-gateway:8000
    depends_on:
      - staytrack-gateway
    networks:
      - staytrack-net

volumes:
  db_data:

networks:
  staytrack-net:
    driver: bridge
